import{app}from"../../scripts/app.js";import{IoDirection,addConnectionLayoutSupport,applyMixins,followConnectionUntilType}from"./utils.js";class RickLabelService{static isStarted=!1;static intervalId=null;static notChange=!1;static StartService(o){this.isStarted||(console.log("启动节点监听器",o),this.isStarted=!0,this.intervalId=setInterval(()=>{let e=!0,i=!1;for(var t of o._nodes)if("RickLabel"===t.type&&(i=!0,0===t.mode)){e=!1;break}i&&e&&(console.error("异常: 所有 RickLabel 节点的 mode 都不为零"),o._nodes=[],clearInterval(this.intervalId),this.isStarted=!1)},100))}}class RickLabelMix{constructor(){this.scheduleStabilizePromise=null,this.nodeType=null}onConnectionsChange(e,i,t,o,s){var n;null!=(n=super.onConnectionsChange)&&n.call(this,e,i,t,o,s),this.scheduleStabilize()}onConnectionsChainChange(){this.scheduleStabilize()}scheduleStabilize(i=64){return this.scheduleStabilizePromise||(this.scheduleStabilizePromise=new Promise(e=>{setTimeout(()=>{this.scheduleStabilizePromise=null,this.stabilize(),e()},i)})),this.scheduleStabilizePromise}stabilize(){let e=followConnectionUntilType(this,IoDirection.INPUT,void 0,!0);e=e||followConnectionUntilType(this,IoDirection.OUTPUT,void 0,!0),this.nodeType=(null===e||void 0===e?void 0:e.type)||"*";for(const i of this.inputs)i.type=this.nodeType;for(const t of this.outputs)t.type=this.nodeType,t.label=(Array.isArray(this.nodeType)||this.nodeType.includes(","))&&(null===e||void 0===e?void 0:e.label)||String(this.nodeType)}static setUp(e){RickLabelMix.title=e.title,RickLabelMix.type=e.type||e.title,RickLabelMix.comfyClass=e.comfyClass,setTimeout(()=>{RickLabelMix.category=e.category}),applyMixins(e,[RickLabelMix]),addConnectionLayoutSupport(e,app,[["Left","Right"],["Right","Left"]])}onRemoved(){this.graph._nodes=[]}onExecuted(e){}}app.registerExtension({name:"rick.RickLabel",async beforeRegisterNodeDef(e,i,t){"RickLabel"===i.name&&(RickLabelService.StartService(t.graph),RickLabelMix.setUp(e))}}),app.registerExtension({name:"rick.RickCardCodeInput",async beforeRegisterNodeDef(e,i,t){"RickCardCodeInput"===i.name&&(RickLabelService.StartService(t.graph),RickLabelMix.setUp(e))}});